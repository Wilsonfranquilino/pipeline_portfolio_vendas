version: '3.8'

services:
  airbyte-server:
    image: airbyte/server:0.50.52  # Versão específica em vez de latest
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      DATABASE_USER: airbyte
      DATABASE_PASSWORD: airbyte
    depends_on:
      - airbyte-db

  airbyte-webapp:
    image: airbyte/webapp:0.50.52
    ports:
      - "8001:80"
    depends_on:
      - airbyte-server

  airbyte-scheduler:
    image: airbyte/scheduler:0.50.52
    environment:
      DATABASE_URL: jdbc:postgresql://airbyte-db:5432/airbyte
      DATABASE_USER: airbyte
      DATABASE_PASSWORD: airbyte
    depends_on:
      - airbyte-server

  airbyte-db:
    image: postgres:13
    environment:
      POSTGRES_USER: airbyte
      POSTGRES_PASSWORD: airbyte
      POSTGRES_DB: airbyte
    volumes:
      - airbyte-db-data:/var/lib/postgresql/data

  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z  # Versão específica
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio-data:/data

  dbt:
    image: python:3.9-slim
    command: tail -f /dev/null
    volumes:
      - ./dbt_project:/dbt
    depends_on:
      - minio
    entrypoint: >
      /bin/bash -c "pip install dbt-core dbt-duckdb duckdb==0.9.2 && dbt --version && /bin/bash"

volumes:
  airbyte-db-data:
  minio-data: